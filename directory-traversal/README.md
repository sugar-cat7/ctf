## ディレクトリトラバーサルについて

### 概要

`../`のような親ディレクトリを参照できるようなパスをパラメータをアプリケーションに与え、本来非公開であるはずのファイルを取得できてしまうような脆弱性

```bash
docker compose up
```

http://localhost:5001/ にアクセス

- どうやってディレクトリをトラバースするのか。
  - ファイルシステムでは`../`を用いて親ディレクトリを参照
  - `/home/user/../` と `/home/`と等価

デモアプリは`route_memo`に脆弱性が存在している。
パラメータ key に指定された値を結合しているが、親ディレクトリに関しての制約が一切ない。
`tmp/files/[パラメータ-keyの値]`

例えば、ローカルユーザの情報を含む`/etc/passwd`を閲覧するためには`tmp/files/`から 2 度親ディレクトリを遡ると`tmp/files/../../etc/passwd`と指定できる。

これを踏まえて`key`にパスを渡すと...

http://localhost:5001/memo?key=../../etc/passwd

- フラグの取得
  実は`init`の処理で環境変数を渡しているので、ディレクトリトラバーサルを使用してこの環境変数を見てみる。

  - 前提

    - Linux においては、プロセスの情報は`proc擬似ファイルシステム`に存在する
    - `proc擬似ファイルシステム`に存在する`environ`から環境変数を取得することが可能
    - `proc擬似ファイルシステム`は`/proc`にマウントされている
      - `/proc/[process id]/`ごとにフォルダが存在する
      - `/proc/self/`は自分自身のプロセスのフォルダを参照可能なシンボリックリンク

  - 以上を踏まえると、あるプロセスが自分自身の環境変数一覧の内容を取得するためには`/proc/self/environ`を参照すれば良い

  - http://localhost:5001/memo?key=../../proc/self/environ

## 対策

[安全なウェブサイトの作り方 - 1.3 パス名パラメータの未チェック／ディレクトリ・トラバーサル](https://www.ipa.go.jp/security/vuln/websecurity-HTML-1_3.html)

■ 根本的解決

- 3-(i)-a
  外部からのパラメータでウェブサーバ内のファイル名を直接指定する実装を避ける。
  外部からのパラメータでウェブサーバ内のファイル名を直接指定する実装では、そのパラメータが改変され、任意のファイル名を指定されることにより公開を想定しないファイルが外部から閲覧される可能性があります。たとえば、HTML 中の hidden パラメータでウェブサーバ内のファイル名を指定し、そのファイルをウェブページのテンプレートとして使用する実装では、そのパラメータが改変されることで、任意のファイルをウェブページとして出力してしまう等の可能性があげられます。

  外部からのパラメータでウェブサーバ内のファイル名を直接指定する実装が本当に必要か、他の処理方法で代替できないか等、仕様や設計から見直すことをお勧めします。

- 3-(i)-b
  ファイルを開く際は、固定のディレクトリを指定し、かつファイル名にディレクトリ名が含まれないようにする。
  たとえば、カレントディレクトリ上のファイル「filename」を開くつもりで、open(filename) の形式でコーディングしている場合、open(filename) の filename に絶対パス名が渡されることにより、任意ディレクトリのファイルが開いてしまう可能性があります。この絶対パス名による指定を回避する方法として、あらかじめ固定のディレクトリ「dirname」を指定し、open(dirname+filename) のような形でコーディングする方法があります。しかし、これだけでは、「../」等を使用したディレクトリ・トラバーサル攻撃を回避できません。これを回避するために、basename() 等の、パス名からファイル名のみを取り出す API を利用して、open(dirname+basename(filename)) のような形でコーディングして、filename に与えられたパス名からディレクトリ名を取り除くようにします（\*1）。

→ 避けられない場合は**正規化する**

- 保険的対策
  3-(ii)
  ウェブサーバ内のファイルへのアクセス権限の設定を正しく管理する。
  ウェブサーバ内に保管しているファイルへのアクセス権限が正しく管理されていれば、ウェブアプリケーションが任意ディレクトリのファイルを開く処理を実行しようとしても、ウェブサーバ側の機能でそのアクセスを拒否できる場合があります。

- 3-(iii)
  ファイル名のチェックを行う。
  ファイル名を指定した入力パラメータの値から、「/」、「../」、「..\」等、OS のパス名解釈でディレクトリを指定できる文字列を検出した場合は、処理を中止します。ただし、URL のデコード処理を行っている場合は、URL エンコードした「%2F」、「..%2F」、「..%5C」、さらに二重エンコードした「%252F」、「..%252F」、「..%255C」がファイル指定の入力値として有効な文字列となる場合があります。チェックを行うタイミングに注意してください。

```bash
docker container exec -it dirtrav-app_app_1 bash
```
